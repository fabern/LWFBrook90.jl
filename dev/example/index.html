<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example · LWFBrook90.jl</title><link rel="canonical" href="https://fabern.github.io/LWFBrook90.jl/example/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="LWFBrook90.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">LWFBrook90.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">About</a></li><li><a class="tocitem" href="../model/">SVAT Model</a></li><li><a class="tocitem" href="../user-guide/">User Guide</a></li><li class="is-active"><a class="tocitem" href>Example</a><ul class="internal"><li><a class="tocitem" href="#Step-by-step-instructions"><span>Step-by-step instructions</span></a></li><li><a class="tocitem" href="#Plotting-results"><span>Plotting results</span></a></li><li><a class="tocitem" href="#Comparison-with-LWFBrook90R"><span>Comparison with LWFBrook90R</span></a></li></ul></li><li><a class="tocitem" href="../code-lst/">Code Listing</a></li><li><a class="tocitem" href="../function-docs/">Function Documentations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/fabern/LWFBrook90.jl/blob/master/docs/src/example.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h1><p>Example data from Beatenberg is located in subfolder <code>example/</code>. WSL is acknowledged for providing the input data (see section <a href="../#Acknowledgments">Acknowledgments</a>).</p><h2 id="Step-by-step-instructions"><a class="docs-heading-anchor" href="#Step-by-step-instructions">Step-by-step instructions</a><a id="Step-by-step-instructions-1"></a><a class="docs-heading-anchor-permalink" href="#Step-by-step-instructions" title="Permalink"></a></h2><p>To run the example simulation simulation simply call LWFBrook90.run_example(). For more control either run the script <code>main.jl</code>or follow the step-by-step instructiosn below.</p><p>Load packages:</p><pre><code class="language-Julia">using LWFBrook90
using OrdinaryDiffEq: solve, Tsit5</code></pre><p>Define and read in input data</p><pre><code class="language-Julia"> # 1a) Read in input data
input_prefix = &quot;BEA2016-reset-FALSE&quot;
input_path = &quot;example/&quot;*input_prefix*&quot;-input/&quot;

(input_meteo,
    input_param,
    input_siteparam,
    input_precdat,    #TODO(bernhard): input_precdat is unused
    input_pdur,
    input_soil_materials,
    input_soil_nodes,
    input_reference_date) = read_LWFBrook90R_inputData(input_path, input_prefix)</code></pre><p>Now the user has the possibility to modify these input objects:</p><pre><code class="language-Julia"># 1b) Here posibility to modify dataframes input_[...] manually</code></pre><p>After that the objects are further parsed and simulation parameters are defined. The user can select whether intermediate quantities such as e.g. evaporation fluxes should be stored during simulation (<code>compute_intermediate_quantities = true</code>) or whether processing steps during simulation should be kept to a minimum for performance reasons (<code>compute_intermediate_quantities = false</code>).</p><pre><code class="language-Julia"># 1c) Parse loaded/redefined input files
(pfile_meteo, pfile_param, pfile_siteparam, pfile_precdat, pfile_pdur, pfile_soil) =
    derive_params_from_inputData(input_meteo,
                                 input_param,
                                 input_siteparam,
                                 input_precdat,
                                 input_pdur,
                                 input_soil_materials,
                                 input_soil_nodes,
                                 input_reference_date)
</code></pre><pre><code class="language-Julia">####################
# Define simulation
# Soil hydraulic model
IMODEL = pfile_param[&quot;IMODEL&quot;] # 0 for Clapp-Hornberger; 1 for Mualem-van Genuchten
NLAYER = pfile_param[&quot;NLAYER&quot;]

# Define solver options
NOOUTF    = 1 == pfile_param[&quot;NOOUTF&quot;] # 1 if no outflow allowed from roots, otherwise 0
Reset     = 0 # currently only Reset = 0 implemented

constant_dt_solver = 1 # [days]

# Flag whether ODE containes additional quantities than only states
compute_intermediate_quantities = true
####################</code></pre><p>Then functions from the package are used to define the problem that will be handed to the solver from DifferentialEquations.jl. That is we need to define <code>p</code>, <code>u0</code>, and <code>tspan</code></p><p><code>p</code>:</p><pre><code class="language-Julia">####################
# Define parameters for differential equation
p = define_LWFB90_p(NLAYER, IMODEL, constant_dt_solver,
                    NOOUTF, Reset, compute_intermediate_quantities,
                    pfile_meteo,
                    pfile_siteparam,
                    pfile_param,
                    pfile_soil,
                    pfile_pdur)
####################</code></pre><p><code>u0</code>:</p><pre><code class="language-Julia">####################
# Define initial states of differential equation
# state vector: GWAT,INTS,INTR,SNOW,CC,SNOWLQ,SWATI
u_GWAT_init = pfile_siteparam[&quot;u_GWAT_init&quot;]
u_SNOW_init = pfile_siteparam[&quot;u_SNOW_init&quot;]
u_INTS_init = pfile_param[&quot;INTS_init&quot;];
u_INTR_init = pfile_param[&quot;INTR_init&quot;];
u_CC_init     = 0; # any initial snow has zero liquid water and cold content
u_SNOWLQ_init = 0; # any initial snow has zero liquid water and cold content

u_aux_PSIM_init = pfile_soil[&quot;PSIM_init&quot;]

######
# Transform initial value of auxiliary state u_aux_PSIM_init into state u_SWATIinit:
u_SWATIinit  = fill(NaN, NLAYER)
if any( u_aux_PSIM_init.&gt; 0)
    error(&quot;Initial matrix psi must be negative or zero&quot;)
end
if IMODEL == 0
    error(&quot;IMODEL==0 is not implemented to get initial SWATI.&quot;)
    # TODO(bernhard): implement this.
elseif IMODEL == 1
    p_SWATMX = p[1][1][6]
    # TODO(bernhard): this hardcoded index is dangerous in case definition of p vector changes
    p_MvGα   = pfile_soil[&quot;PAR&quot;][!,&quot;α&quot;]
    p_MvGn   = pfile_soil[&quot;PAR&quot;][!,&quot;n&quot;]
    p_THSAT  = pfile_soil[&quot;PAR&quot;][!,&quot;θs&quot;]
    p_θr     = pfile_soil[&quot;PAR&quot;][!,&quot;θr&quot;]
    # TODO(bernhard): store above quantities somewhere else than p[1][1][3] and pfile_soil?
    for i = 1:NLAYER
        # Define initial u_SWATI based on input parameter
        u_aux_WETNESinit_i = LWFBrook90.jl.KPT.FWETNES_MvG(u_aux_PSIM_init[i],
                                                             p_MvGα[i],
                                                             p_MvGn[i])
        u_SWATIinit[i]     = p_SWATMX[i]/p_THSAT[i] *
                             LWFBrook90.jl.KPT.FTheta_MvG(u_aux_WETNESinit_i,
                                                            p_THSAT[i],
                                                            p_θr[i])

    end
end
######


# Create u0 for DiffEq.jl
u0 = define_LWFB90_u0(u_GWAT_init,
                      u_INTS_init,
                      u_INTR_init,
                      u_SNOW_init,
                      u_CC_init,
                      u_SNOWLQ_init,
                      u_SWATIinit,
                      compute_intermediate_quantities)
####################</code></pre><p><code>tspan</code>:</p><pre><code class="language-Julia">####################
# Define ODE problem which consists of
#   - definition of right-hand-side (RHS) function f
#   - definition of callback function cb
#   - u0:     initial condition of states
#   - tspan:  definition of simulation time span
#   - p:      parameters

# Define simulation time span:
tspan = (minimum(input_meteo[:,&quot;days&quot;]),
         maximum(input_meteo[:,&quot;days&quot;])) # simulate all available days
# Define ODE:
ode_LWFBrook90 = define_LWFB90_ODE(u0, tspan, p)

# Alternative definitions of tspan:
# tspan = (0.,  5.) # simulate 5 days
# tspan = (0.,  100.) # simulate 100 days
# simulates specific period:
# tspan = (LWFBrook90.jl.DateTime2RelativeDaysFloat(DateTime(1980,1,1), reference_date),
#          LWFBrook90.jl.DateTime2RelativeDaysFloat(DateTime(1985,1,1), reference_date))
####################</code></pre><p>Then the ODE problem can be solved:</p><pre><code class="language-Julia">####################
## Solve ODE:
sol_LWFBrook90 = solve(ode_LWFBrook90, Tsit5();
    progress = true,
    saveat = tspan[1]:tspan[2], dt=1e-6, adaptive = true); # dt will be overwritten
####################</code></pre><p>Note to use the progress bar during the solve the optional package should additionally be installed and loaded: <code>using ProgressLogging</code>.</p><p>The generated solution can be plotted using the plotting recipes of DifferntialEquations.jl for Plots.jl (<a href="https://diffeq.sciml.ai/stable/basics/plot/">see instructions</a>)</p><pre><code class="language-Julia">####################
## Plotting
using Plots
sol_LWFBrook90_Dates =
    LWFBrook90.jl.RelativeDaysFloat2DateTime.(
        sol_LWFBrook90.t,
        input_reference_date)

# Plot scalar quantities
# Using dates (but not interpolated)
plot(sol_LWFBrook90_Dates,
    sol_LWFBrook90[[1,2,3,4,5,6],:]&#39;,
    label=[&quot;GWAT&quot; &quot;INTS&quot; &quot;INTR&quot; &quot;SNOW&quot; &quot;CC&quot; &quot;SNOWLQ&quot;])

# Using simple plot recipe that interpolates, but without dates
plot(sol_LWFBrook90;
    vars = [1, 2, 3, 4, 5, 6],
    label=[&quot;GWAT&quot; &quot;INTS&quot; &quot;INTR&quot; &quot;SNOW&quot; &quot;CC&quot; &quot;SNOWLQ&quot;])

# Plot vector quantities
# http://docs.juliaplots.org/latest/generated/gr/#gr-ref43
x = sol_LWFBrook90_Dates
y = cumsum(pfile_soil[&quot;THICK&quot;])
z = sol_LWFBrook90[7 .+ (0:example[&quot;NLAYER&quot;]-1), :]./pfile_soil[&quot;THICK&quot;]
heatmap(x, y, z,
    yflip = true,
    xlabel = &quot;Date&quot;,
    ylabel = &quot;Depth&quot;,
    colorbar_title = &quot;θ&quot;)</code></pre><h2 id="Plotting-results"><a class="docs-heading-anchor" href="#Plotting-results">Plotting results</a><a id="Plotting-results-1"></a><a class="docs-heading-anchor-permalink" href="#Plotting-results" title="Permalink"></a></h2><p>Following plots illustrate results of the provided data set. The scalar state variables and depth-depenedent (vector) state variables can be plotted:</p><p align="center">
<img src="../assets/git-hash-b3f7183/2021-02-24_16h56_LWFBrook90Julia_plot_u_scalar.png" width="400"><br>
<br><em><b>Figure 2</b>: Example simulation: scalar results</em><br>
<p><p align="center">
<img src="../assets/git-hash-b3f7183/2021-02-24_16h56_LWFBrook90Julia_plot_u_vector.png" width="400"><br>
<br><em><b>Figure 3</b>: Example simulation: vector results soil water</em><br>
<p><h2 id="Comparison-with-LWFBrook90R"><a class="docs-heading-anchor" href="#Comparison-with-LWFBrook90R">Comparison with LWFBrook90R</a><a id="Comparison-with-LWFBrook90R-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-with-LWFBrook90R" title="Permalink"></a></h2><p>Tests are run to assert agreement with results from LWFBrook90R. Visualizations are reported below. Note that minor discrepancies ```@raw htmlare still present linked to the adaptive time stepping and intermediate updates of state variables.</p><p align="center">
<img src="../assets/git-hash-b3f7183/2021-02-24_16h56_R-vs-Julia_comparison_DailyRawValues.png" width="400"><br>
<br><em><b>Figure 4</b>: Comparing daily outputs of LWFBrook90R and LWFBrook90.jl for example data set over a year</em><br>
<p><p align="center">
<img src="../assets/git-hash-b3f7183/2021-02-24_16h56_R-vs-Julia_comparison_DailyRawValues_first3months.png" width="400"><br>
<br><em><b>Figure 5</b>: Comparing daily outputs of LWFBrook90R and LWFBrook90.jl for example data set over 3 months</em><br>
<p><p>Note that some features of LWFBrook90R are not implemented in the main version of LWFBrook90.jl. The time step adaptivity and <code>Reset==1</code> are major ones that require some code refactoring that is not how the library for ODEs DiffEq.jl is intended to be used. Because of that implementation of these features is currently in a feature branch here on git <code>feature 005</code>. Below are some of the results of that code:</p><p align="center">
<img src="../assets/git-hash-2-55ca42d-feature005/2021-02-24_19h10_R-vs-Julia_comparison_DailyRawValues.png" width="400"><br>
<br><em><b>Figure 6</b>: Comparing daily outputs of LWFBrook90R and experimental LWFBrook90.jl:feature-005 for example data set over a year</em><br>
<p><p align="center">
<img src="../assets/git-hash-2-55ca42d-feature005/2021-02-24_19h10_R-vs-Julia_comparison_DailyRawValues_first3months.png" width="400"><br>
<br><em><b>Figure 7</b>: Comparing daily outputs of LWFBrook90R and experimental LWFBrook90.jl:feature-005 for example data set over 3 months</em><br>
<p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../user-guide/">« User Guide</a><a class="docs-footer-nextpage" href="../code-lst/">Code Listing »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 9 March 2021 23:17">Tuesday 9 March 2021</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
